/*!
 * jQuery async plugin
 *
 * @fileoverview  jQuery async plugin
 * @version       0.1.0
 * @date          2014-09-27
 * @link          https://github.com/polygonplanet/jquery-async-plugin
 * @copyright     Copyright (c) 2013-2014 polygon planet <polygon.planet.aqua@gmail.com>
 * @license       Licensed under the MIT license.
 */
(function(c){"use strict";function m(a){return null!=a&&(a instanceof Error||"error"===c.type(a))}var l=Array.prototype.slice,h=function(){function a(b){return this.init(b)}function d(b){return null!=b&&b.Deferred===a}function f(b){return!!(b^3)}function g(b){return m(b)?b:Error(b)}function k(b){this.state=m(b)?1:0}function e(){for(var b=this.chain,a=0,e=b.length;a<e;a++)if(b[a]&&c.isFunction(b[a][1]))return!0;return!1}function n(b){k.call(this,b);this.results[this.state]=b;return p.call(this)}function p(){var b=
this,a=b.chain,c=b.results[b.state],h,l,m;b._unhandledErrorTimerId&&f.call(b)&&e.call(b)&&(clearTimeout(b._unhandledErrorTimerId),delete b._unhandledErrorTimerId);for(;a.length&&!b.paused;)if(l=a.shift()[b.state])try{c=l.call(b,c),k.call(b,c),d(c)&&(h=function(a){n.call(b,a);b.paused--;!b.paused&&f(b.state)&&p.call(b)},b.paused++)}catch(q){b.state=1,c=g(q),e.call(b)||(m=!0)}b.results[b.state]=c;h&&b.paused&&(c.addBoth(h),c.chained=!0);m&&(b._unhandledErrorTimerId=setTimeout(function(){try{throw c;
}finally{delete b._unhandledErrorTimerId}},0));return b}a.prototype={Deferred:a,state:3,paused:0,chained:!1,_unhandledErrorTimerId:null,init:function(b){this.chain=[];this.results=[null,null];this.canceller=b;return this},cancel:function(){this.chain.length=0;3===this.state?this.canceller&&this.canceller(this):2===this.state&&d(this.results[0])&&this.results[0].cancel();return this},callback:function(b){return n.call(this,b)},errback:function(b){return n.call(this,g(b))},addBoth:function(b){return this.addCallbacks(b,
b)},addCallback:function(b){return this.addCallbacks(b,null)},addErrback:function(b){return this.addCallbacks(null,b)},addCallbacks:function(b,a){this.chained||(this.chain.push([b,a]),f(this.state)&&p.call(this));return this}};a.isDeferred=d;return a}();(function(){function a(a,e){a._deferred=e;e._jquery=a;a.deferrize=function(){return this._deferred};var d=e.cancel;e.cancel=function(){this._jquery&&this._jquery.canceller&&(this.canceller=this._jquery.canceller);return d.apply(this,arguments)};c.each(f,
function(c,b){a[b]=function(){return e[b].apply(e,arguments)}});return a}function d(c,e){a(c,e);c.callback=function(){return e.callback.apply(e,arguments)};c.errback=function(){return e.errback.apply(e,arguments)};e.promise=function(){return this};var d=c.promise;c.promise=function(){return a(d.apply(this,arguments),this._deferred)};return c}var f=["addCallback","addErrback","addCallbacks","addBoth","cancel"],g=c.Deferred;c.Deferred=function(){var a=new h;return d(g.apply(this,arguments),a)}})();
var q=function(){var a;a="object"===typeof process&&"function"===typeof process.nextTick?process.nextTick:void 0;var c=function(){if("function"===typeof setImmediate)return function(a){try{return setImmediate(a)}catch(f){return(c=k)(a)}}}(),f=function(){var a,c;if("function"!==typeof MessageChannel)return!1;try{a=new MessageChannel;if(!a.port1||!a.port2)return!1;c=[];a.port1.onmessage=function(){c.shift()()}}catch(d){return!1}return function(b){c.push(b);a.port2.postMessage("")}}(),g=function(){if("object"!==
typeof window||"object"!==typeof document||"function"!==typeof Image||"function"!==typeof document.addEventListener)return!1;try{if("function"!==typeof(new Image).addEventListener)return!1}catch(a){return!1}return function(a){var c=new Image,b=!1,d=function(){c.removeEventListener("load",d,!1);c.removeEventListener("error",d,!1);b||(b=!0,a())};c.addEventListener("load",d,!1);c.addEventListener("error",d,!1);try{c.src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw=="}catch(e){(g=
k)(a)}}}(),k=function(a,c){return setTimeout(a,c||0)};return function(e){return(a||c||f||g||k)(e)}}();c.async=function(a){var d=new h,f;if(c.isFunction(a)){var g=l.call(arguments,1);d.addCallback(function(){return a.apply(this,g)})}else f=a;q(function(){d.callback(f)});return d};c.extend(c.async,{Deferred:h,isError:m,isDeferred:h.isDeferred,isjQueryDeferred:function(a){return null!=a&&c.isFunction(a.always)},succeed:function(){var a=new h;return a.callback.apply(a,arguments)},fail:function(){var a=
new h;return a.errback.apply(a,arguments)},maybeDeferred:function(a){var d,f;try{if(m(a))throw a;f=c.isFunction(a)?a.apply(a,l.call(arguments,1)):a;d=c.async.isDeferred(f)?f:c.async.succeed(f)}catch(g){d=c.async.fail(g)}return d},maybeDeferreds:function(){return c.map(l.call(arguments),c.async.maybeDeferred)},wait:function(a,c){var f,g=l.call(arguments,1),k=new h(function(){clearTimeout(f)});f=setTimeout(function(){k.callback()},Math.floor(1E3*(a-0||0)));g.length&&k.addCallback(function(){return c});
return k},callLater:function(a,d){var f=l.call(arguments,2);return c.async.wait(a).addCallback(function(){return c.async.isDeferred(d)?d.callback.apply(d,f):c.isFunction(d)?d.apply(d,f):d})},till:function(a){var d=new h,f=l.call(arguments,1),g,k,e=function(){if(!k){if(g)return setTimeout(e,13);g=!0;var h=c.now();c.async(function(){return a.apply(this,f)}).addCallback(function(a){a?(k=!0,d.callback()):(a=Math.max(1,Math.min(1E3,13+(c.now()-h))),setTimeout(function(){g=!1;e()},a))})}};c.async(e);return d}})})(jQuery);
